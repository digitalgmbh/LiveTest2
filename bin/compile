#!/usr/bin/env php
<?php

$rootDir = getcwd();
// php on windows can't use the shebang line from system()
$interpreter = PHP_OS == 'WINNT' ? 'php.exe' : '';
$box = $rootDir.'/box.phar';

//get box
if(file_exists($box)){
    system(sprintf('php %s', $box.' update'), $composerable);
} else {
    system(sprintf('curl %s | php -d=phar.readonly=Off -d=phar.require_hash=Off', 'http://box-project.org/installer.php'), $composerable);
}

ob_start();
passthru('git rev-parse HEAD');
$version = ob_get_clean();

//update if composer can be run
if (isset($composerable) && $composerable == 0) {
    $version = substr($version, 0, 7);
    $boxFile = $rootDir.'/box.json';
    file_put_contents($boxFile, str_replace('@git-version@', $version, file_get_contents($boxFile)));

    system(sprintf('php %s', $box.' build'));

    passthru('git checkout -- '.$boxFile);
}